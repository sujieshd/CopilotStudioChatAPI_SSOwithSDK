<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Copilot Chat with Sendbox Pinned</title>
  <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/botframework-webchat@4.18.1-main.20241015.4744d69/dist/webchat.js"></script>
  <script src="https://unpkg.com/botframework-webchat-fluent-theme@4.18.1-main.20241015.4744d69/dist/botframework-webchat-fluent-theme.production.min.js"></script>
  <script src="https://unpkg.com/copilot-studio-direct-to-engine-chat-adapter@0.0.0-main.20241022-173702.3e37c28/dist/copilot-studio-direct-to-engine-chat-adapter.production.global.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background-color: #f0f0f0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    #webchat-container {
      width: 1000px;
      height: 600px;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 10px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      overflow: hidden;
    }

    #webchat {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }

    #topbar {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      font-size: 13px;
      color: #242424;
    }

    #signin-top {
      padding: 7px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .typing-indicator {
      min-height: 24px;
      transition: padding 0.2s ease;
      padding: 0;
      display: flex;
      align-items: flex-end;
    }

    .typing-indicator.active {
      padding: 8px 0;
    }

    .typing-bubble {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      padding: 8px 12px;
      margin-left: 16px;
      font-size: 14px;
      color: #242424;
      font-style: italic;
      border: 1px solid #e6e6e6;
      max-width: 75%;
      animation: blinkBubble 1.4s infinite;
    }

    @keyframes blinkBubble {
      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }
  </style>
</head>

<body>
  <div id="topbar">
    <span id="auth-status">Signed out</span>
    <button id="signin-top" type="button">Sign in</button>
  </div>

  <div id="webchat-container">
    <div id="webchat" role="main"></div>
  </div>

  <script>
    const msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: "be62b702-ec48-415a-b36b-91f6c84716ae", // Replace with your Microsoft Entra application client ID
        authority: "https://login.microsoftonline.com/50e627b2-4aa4-4b2f-a97f-a00e384850ca", // Replace with your tenant ID
        redirectUri: `${window.location.origin}${window.location.pathname}`
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: true
      }
    });

    const loginRequest = {
      scopes: ["https://api.powerplatform.com/CopilotStudio.Copilots.Invoke"]
    };

    // Optional: enable best-effort silent SSO by supplying a login hint in the URL,
    // e.g. https://.../index.html?login_hint=user@contoso.com
    const loginHint = new URLSearchParams(window.location.search).get('login_hint') || undefined;

    function isMsalInteractionRequired(e) {
      const errorCode = e?.errorCode ?? e?.code;
      return [
        'interaction_required',
        'login_required',
        'consent_required',
        'no_tokens_found'
      ].includes(errorCode);
    }

    function TypingIndicator({ isTyping }) {
      return React.createElement(
        'div',
        { className: `typing-indicator${isTyping ? ' active' : ''}` },
        isTyping
          ? React.createElement('div', { className: 'typing-bubble' }, 'Retrieving...')
          : ''
      );
    }

    async function getToken() {
      const accounts = msalInstance.getAllAccounts();

      if (accounts.length > 0 && !msalInstance.getActiveAccount?.()) {
        msalInstance.setActiveAccount?.(accounts[0]);
      }

      const account = msalInstance.getActiveAccount?.() ?? accounts[0];
      if (!account) {
        throw new Error('Not signed in');
      }

      return (await msalInstance.acquireTokenSilent({ ...loginRequest, account })).accessToken;
    }

    async function getTokenInteractive() {
      const result = await msalInstance.acquireTokenPopup({
        ...loginRequest,
        prompt: 'select_account'
      });

      if (result?.account) {
        msalInstance.setActiveAccount?.(result.account);
      }

      return result.accessToken;
    }

    let interactiveTokenPromise = null;
    let interactiveTokenResolve = null;
    let interactiveTokenReject = null;

    let chatStarted = false;

    function updateAuthUi() {
      const statusEl = document.getElementById('auth-status');
      const btn = document.getElementById('signin-top');
      if (!statusEl || !btn) {
        return;
      }

      const account = msalInstance.getActiveAccount?.() ?? msalInstance.getAllAccounts?.()[0];
      if (account) {
        statusEl.textContent = `Signed in: ${account.username ?? account.name ?? 'account'}`;
        btn.textContent = 'Switch account';
      } else {
        statusEl.textContent = 'Signed out';
        btn.textContent = 'Sign in';
      }
    }

    function ensureInteractiveTokenPromise() {
      if (interactiveTokenPromise) {
        return interactiveTokenPromise;
      }

      interactiveTokenPromise = new Promise((resolve, reject) => {
        interactiveTokenResolve = resolve;
        interactiveTokenReject = reject;
      });

      return interactiveTokenPromise;
    }

    async function runInteractiveSignIn() {
      try {
        const token = await getTokenInteractive();
        document.getElementById('auth-overlay')?.remove();
        updateAuthUi();
        interactiveTokenResolve?.(token);
        if (!chatStarted) {
          startChat();
        }
      } catch (e) {
        const err = document.querySelector('#auth-overlay #auth-error');
        if (err) {
          err.textContent = `Authentication failed: ${e?.message ?? e}`;
        }
        interactiveTokenReject?.(e);
      } finally {
        interactiveTokenPromise = null;
        interactiveTokenResolve = null;
        interactiveTokenReject = null;
      }
    }

    function renderAuthPrompt(message) {
      if (document.getElementById('auth-overlay')) {
        return;
      }

      const overlay = document.createElement('div');
      overlay.id = 'auth-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(255, 255, 255, 0.92)';
      overlay.style.zIndex = '9999';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'flex-start';
      overlay.style.justifyContent = 'center';
      overlay.style.padding = '32px 16px';

      overlay.innerHTML = `
        <div style="font-family: sans-serif; max-width: 900px; width: 100%;">
          <div style="color: #b00020; margin-bottom: 12px;">${message}</div>
          <button id="signin" style="padding: 10px 14px; font-size: 14px; cursor: pointer;">Sign in</button>
          <div id="auth-error" style="color: #b00020; margin-top: 12px;"></div>
          ${loginHint ? '' : '<div style="margin-top: 10px; color: #666; font-size: 12px;">Tip: for best-effort silent SSO, add <code>?login_hint=user@domain.com</code> to the URL.</div>'}
        </div>
      `;

      document.body.appendChild(overlay);

      // Bind overlay button to the same interactive sign-in flow as the top bar.
      const btn = overlay.querySelector('#signin');
      btn?.addEventListener('click', async () => {
        ensureInteractiveTokenPromise();
        await runInteractiveSignIn();
      });
    }

    function getTokenOrPrompt() {
      if (interactiveTokenPromise) {
        return interactiveTokenPromise;
      }

      return getToken().catch(e => {
        const isNotSignedIn = e?.message === 'Not signed in';
        if (isNotSignedIn || isMsalInteractionRequired(e)) {
          renderAuthPrompt('Authentication required. Click Sign in to continue.');

          // Returns a promise that resolves when the user clicks Sign in (top bar or overlay).
          return ensureInteractiveTokenPromise();
        }

        throw e;
      });
    }

    async function ensureSignedInSilently() {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        if (!msalInstance.getActiveAccount?.()) {
          msalInstance.setActiveAccount?.(accounts[0]);
        }
        return;
      }

      // True silent SSO requires an existing Entra session + browser allowing the iframe flow.
      // Providing loginHint makes this more reliable.
      if (!loginHint || !msalInstance.ssoSilent) {
        return;
      }

      try {
        const result = await msalInstance.ssoSilent({
          ...loginRequest,
          loginHint,
          prompt: 'none'
        });
        if (result?.account) {
          msalInstance.setActiveAccount?.(result.account);
        }
      } catch {
        // Ignore and fall back to user-click interactive sign-in.
      }
    }

    async function startChat() {
      if (chatStarted) {
        return;
      }
      chatStarted = true;

      const strategy = new window.CopilotStudioDirectToEngineChatAdapter.ThirdPartyPublishedBotStrategy({
        botSchema: 'cr336_jieAgent', // Replace with your Copilot Studio Agent schema name
        environmentEndpointURL: new URL('https://f4fc370784d1e106bdc328e8a7e575.9d.environment.api.powerplatform.com/'), // Replace with your Power Platform environment endpoint
        getToken: () => getTokenOrPrompt(),
        transport: 'auto'
      });

      const directLine = window.CopilotStudioDirectToEngineChatAdapter.toDirectLineJS(
        window.CopilotStudioDirectToEngineChatAdapter.createHalfDuplexChatAdapter(strategy, { emitStartConversationEvent: true })
      );

      const { Components } = window.WebChat;
      const { useState, useEffect } = window.React;

      const App = () => {
        const [isTyping, setIsTyping] = useState(false);

        useEffect(() => {
          const sub = directLine.activity$.subscribe(activity => {
            if (
              activity.type === 'event' &&
              activity.name === 'DynamicPlanReceived' &&
              Array.isArray(activity?.value?.steps) &&
              activity.value.steps.some(step => step.includes('UniversalSearchTool'))
            ) {
              setIsTyping(true);
            } else if (
              activity.type === 'event' &&
              activity.name === 'DynamicPlanStepFinished' &&
              activity?.value?.taskDialogId === 'P:UniversalSearchTool'
            ) {
              setIsTyping(false);
            }
          });
          return () => sub.unsubscribe();
        }, []);

        return React.createElement(
          Components.AccessKeySinkSurface,
          {
            style: {
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'flex-end',
              height: '100%'
            }
          },
          React.createElement(Components.BasicToaster),
          React.createElement(Components.BasicTranscript),
          React.createElement(TypingIndicator, { isTyping }),
          React.createElement(Components.BasicSendBox)
        );
      };

      window.ReactDOM.render(
        React.createElement(
          window.WebChat.FluentThemeProvider,
          null,
          React.createElement(
            Components.Composer,
            {
              directLine,
              styleOptions: {
                backgroundColor: 'var(--colorNeutralBackground1)',
                bubbleBackground: 'var(--colorNeutralBackground2)',
                bubbleTextColor: 'var(--colorNeutralForeground1)',
                bubbleFromUserBackground: 'var(--colorBrandStroke2)',
                bubbleFromUserTextColor: 'var(--colorNeutralForeground1)',
                timestampColor: 'var(--colorNeutralForeground3)',
                bubbleBorderRadius: 10,
                bubbleFromUserBorderRadius: 10,
              }
            },
            React.createElement(App)
          )
        ),
        document.getElementById('webchat')
      );
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await msalInstance.initialize?.();
        await msalInstance.handleRedirectPromise?.();
        await ensureSignedInSilently();

        updateAuthUi();

        document.getElementById('signin-top')?.addEventListener('click', async () => {
          ensureInteractiveTokenPromise();
          await runInteractiveSignIn();
        });

        // Fetch token up-front (silent if possible); interactive requires user click.
        await getTokenOrPrompt();
        startChat();
      } catch (e) {
        document.body.innerHTML = `<div style="color: red; font-family: sans-serif; padding: 1em;">Authentication failed: ${e?.message ?? e}</div>`;
      }
    });
  </script>
</body>
</html>
